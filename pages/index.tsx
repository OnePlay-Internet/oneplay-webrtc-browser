import React, { useEffect, useRef, } from 'react'
import Head from 'next/head'
import styles from '../styles/Home.module.css'
import { OneplayApp } from '../webrtc/app'
import { useRouter } from 'next/router'

const Home = ({signaling_url} : {signaling_url: string}) => {
  const remoteVideo = useRef<HTMLVideoElement>(null);
  const remoteAudio = useRef<HTMLAudioElement>(null);
  let router = useRouter()
  
  useEffect(() => { 
    if (remoteVideo.current) {
      let token : string
      try {
        token = router.asPath;
        token = token.split("?")[1].split("=")[1]
        if (token == "") {
          throw new Error("no valid token")
        }
      } catch (error) {
        window.location.replace("/main");
      }

      console.log(`Started oneplay app with token ${token}`)
      var app = new OneplayApp(remoteVideo,remoteAudio,token,() => {
        window.close();
      });
    }
  }, [])

  return (
    <div className={styles.app}>
      <Head>
        <title>WebRTC remote viewer</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <video
        ref={remoteVideo}
        className={styles.remoteVideo}
        autoPlay
        muted
        playsInline
        loop
      ></video>
      <audio 
        ref={remoteAudio} 
        autoPlay
        controls
      ></audio>
    </div>
  )
}

export default Home
